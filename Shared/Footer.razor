@using System.Text.Json
@using System.Linq
@using WebApp.Models
@inject WebApp.Services.ContentService Content

@code {
    FooterModel? FooterBasic;

    // In-component bags (from JSON)
    List<(string Title, List<(string Label, string Href)> Links)> Columns = new();
    List<(string Alt, string Src, string Href)> Badges = new();
    List<(string Icon, string Aria, string Href)> Social = new();
    List<(string Label, string Href)> Legal = new();

    string AppHeading = "Get the app";
    string FollowHeading = "Follow";

    // Map any incoming legal label to the correct /legal route while keeping the label
    static string NormalizeLegalHref(string label, string currentHref)
    {
        var l = (label ?? "").ToLowerInvariant();
        if (l.Contains("privacy") || l.Contains("cookie"))
            return "/legal/privacy";
        if (l.Contains("security"))
            return "/legal/security";
        if (l.Contains("terms") || l.Contains("service"))
            return "/legal/terms";
        return currentHref;
    }

    // Make sure we always surface the 3 standard links even if JSON is missing them
    void EnsureStandardLegalLinks()
    {
        bool hasPrivacy  = Legal.Any(x => x.Label.Contains("Privacy", System.StringComparison.OrdinalIgnoreCase)
                                       || x.Label.Contains("Cookie", System.StringComparison.OrdinalIgnoreCase));
        bool hasSecurity = Legal.Any(x => x.Label.Contains("Security", System.StringComparison.OrdinalIgnoreCase));
        bool hasTerms    = Legal.Any(x => x.Label.Contains("Terms", System.StringComparison.OrdinalIgnoreCase));

        if (!hasPrivacy)  Legal.Add(("Privacy & Cookie Policy", "/legal/privacy"));
        if (!hasSecurity) Legal.Add(("Security Policy", "/legal/security"));
        if (!hasTerms)    Legal.Add(("Terms of Service", "/legal/terms"));
    }

    protected override async Task OnInitializedAsync()
    {
        // Copyright (string) from FooterModel
        FooterBasic = await Content.GetFooterModelAsync();

        // Extended footer content from JSON (nav.footer)
        using var doc = await Content.GetAsync<JsonDocument>("nav.footer");
        if (doc is null) return;
        var root = doc.RootElement;

        static string? Str(JsonElement obj, string prop)
            => obj.TryGetProperty(prop, out var v) && v.ValueKind == JsonValueKind.String ? v.GetString() : null;

        static IEnumerable<JsonElement> Arr(JsonElement obj, string prop)
            => obj.TryGetProperty(prop, out var v) && v.ValueKind == JsonValueKind.Array ? v.EnumerateArray() : Enumerable.Empty<JsonElement>();

        // App / Social band
        if (root.TryGetProperty("appBand", out var band) && band.ValueKind == JsonValueKind.Object)
        {
            AppHeading    = Str(band, "getApp") ?? AppHeading;
            FollowHeading = Str(band, "follow") ?? FollowHeading;

            foreach (var b in Arr(band, "badges"))
                Badges.Add((Str(b, "alt") ?? "", Str(b, "src") ?? "#", Str(b, "href") ?? "#"));

            foreach (var s in Arr(band, "social"))
                Social.Add((Str(s, "icon") ?? "bi-link", Str(s, "aria") ?? "", Str(s, "href") ?? "#"));
        }

        // Footer columns
        foreach (var col in Arr(root, "columns"))
        {
            var title = Str(col, "title") ?? "";
            var links = new List<(string, string)>();
            foreach (var l in Arr(col, "links"))
                links.Add((Str(l, "label") ?? "", Str(l, "href") ?? "#"));

            Columns.Add((title, links));
        }

        // Legal links (bottom row) — exactly as webApp.html (normalize to /legal/* when applicable)
        foreach (var l in Arr(root, "legal"))
        {
            var label = Str(l, "label") ?? "";
            var href  = NormalizeLegalHref(label, Str(l, "href") ?? "#");
            Legal.Add((label, href));
        }

        // Fallback: if no explicit "legal" array, try to filter last column
        if (Legal.Count == 0 && Columns.Count > 0)
        {
            var last = Columns.Last();
            var filtered = last.Links
                .Where(x => x.Label.Contains("Privacy", System.StringComparison.OrdinalIgnoreCase)
                         || x.Label.Contains("Cookie",  System.StringComparison.OrdinalIgnoreCase)
                         || x.Label.Contains("Terms",   System.StringComparison.OrdinalIgnoreCase)
                         || x.Label.Contains("Security",System.StringComparison.OrdinalIgnoreCase))
                .Select(x => (x.Label, NormalizeLegalHref(x.Label, x.Href)))
                .ToList();

            if (filtered.Count > 0)
                Legal = filtered;
        }

        // Ensure standard links exist (Privacy, Security, Terms)
        EnsureStandardLegalLinks();

        // De-duplicate by label (keep the first occurrence)
        Legal = Legal
            .GroupBy(x => x.Label, System.StringComparer.OrdinalIgnoreCase)
            .Select(g => g.First())
            .ToList();
    }
}

@if (FooterBasic is null)
{
    <!-- Minimal fallback (rare; JSON failed) -->
    <footer class="bm-footer">
        <div class="container py-4 border-top">
            <div class="d-flex justify-content-between flex-column flex-md-row small text-muted">
                <div>© BioMaint</div>
                <div class="d-flex gap-3">
                    <a class="text-decoration-none" href="/legal/privacy">Privacy & Cookie Policy</a>
                    <a class="text-decoration-none" href="/legal/security">Security Policy</a>
                    <a class="text-decoration-none" href="/legal/terms">Terms of Service</a>
                </div>
            </div>
        </div>
    </footer>
}
else
{
    @* ===== APP DOWNLOAD + SOCIAL (promo band) ===== *@
    @if (Badges.Count > 0 || Social.Count > 0)
    {
        <section class="promo-band">
            <div class="container">
                <div class="row align-items-center gy-3">
                    <div class="col-12 col-lg-6 d-flex flex-column flex-sm-row align-items-center gap-3">
                        <h5 class="m-0">@AppHeading</h5>
                        <div class="store-badges d-flex gap-2">
                            @foreach (var b in Badges)
                            {
                                <a href="@b.Href"><img alt="@b.Alt" src="@b.Src" /></a>
                            }
                        </div>
                    </div>
                    <div class="col-12 col-lg-6 d-flex flex-column flex-sm-row align-items-center justify-content-lg-end gap-3">
                        <h5 class="m-0">@FollowHeading</h5>
                        <div class="social d-flex gap-3 fs-4">
                            @foreach (var s in Social)
                            {
                                <a href="@s.Href" aria-label="@s.Aria"><i class="bi @s.Icon"></i></a>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </section>
    }

    @* ===== FOOTER COLUMNS + BOTTOM ROW ===== *@
    <footer class="bm-footer">
        <div class="container">
            @if (Columns.Count > 0)
            {
                <div class="row g-4">
                    @foreach (var col in Columns)
                    {
                        <div class="col-6 col-md-3 footer-col">
                            <h6>@col.Title</h6>
                            <ul class="list-unstyled">
                                @foreach (var ln in col.Links)
                                {
                                    <li><a href="@ln.Href">@ln.Label</a></li>
                                }
                            </ul>
                        </div>
                    }
                </div>
            }

            <div class="border-top mt-4 pt-3 d-flex justify-content-between flex-column flex-md-row">
                <div>@FooterBasic.Copyright</div>
                <div class="d-flex gap-3">
                    @foreach (var ln in Legal)
                    {
                        <a href="@ln.Href" class="text-decoration-none">@ln.Label</a>
                    }
                </div>
            </div>
        </div>
    </footer>
}
